services:
  landscape:
    image: landscape:local
    build:
      context: .
    ports:
      - "80:80"
      - "443:443"
      - "6554:6554"
    hostname: ${HOSTNAME}.${DOMAIN}
    environment:
      # Landscape bootstrap / quickstart inputs
      EMAIL: "you@example.com"
      TOKEN: ${TOKEN} # put this in .env
      HOSTNAME: ${HOSTNAME}
      DOMAIN: ${DOMAIN}
      TIMEZONE: "Europe/Budapest"

      # SMTP settings
      SMTP_HOST: "localhost"
      SMTP_PORT: "587"
      SMTP_USERNAME: ${SMTP_USERNAME}
      SMTP_PASSWORD: ${SMTP_PASSWORD}

      # Optional / informational
      LANDSCAPE_VERSION: "24.04"
    volumes:
      - landscape-data:/var/lib/landscape
      - landscape-httpd:/etc/apache2
      - landscape-etc:/etc/landscape
      - landscape-pg:/var/lib/postgresql
      - landscape-rmq:/var/lib/rabbitmq
      #- ./certs/landscape_server.pem:/etc/ssl/certs/landscape_server.pem:ro
      #- ./certs/landscape_server.key:/etc/ssl/private/landscape_server.key:ro
    labels:
      - "traefik.enable=true"

      # HTTP -> HTTPS redirect handled by Traefik
      - "traefik.http.routers.landscape-http.rule=Host(`${HOSTNAME}.${DOMAIN}`)"
      - "traefik.http.routers.landscape-http.entrypoints=web"
      - "traefik.http.routers.landscape-http.middlewares=landscape-redirect-https"
      - "traefik.http.middlewares.landscape-redirect-https.redirectscheme.scheme=https"

      # TCP router with TLS passthrough to Apache's :443 inside the container
      - "traefik.tcp.routers.landscape-tls.rule=HostSNI(`${HOSTNAME}.${DOMAIN}`)"
      - "traefik.tcp.routers.landscape-tls.entrypoints=websecure"
      - "traefik.tcp.routers.landscape-tls.tls.passthrough=true"
      - "traefik.tcp.routers.landscape-tls.service=landscape-tls"
      - "traefik.tcp.services.landscape-tls.loadbalancer.server.port=443"

volumes:
  landscape-data:
  landscape-httpd:
  landscape-etc:
  landscape-pg:
  landscape-rmq:
